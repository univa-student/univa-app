name: CI Pipeline

on:
  push:
    branches: [develop, feature/workflow, feature/CI]
  pull_request:

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Global environment
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

  DB_DATABASE: app_test
  DB_USERNAME: app
  DB_PASSWORD: secret

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# JOB 1 â€” Lint & Validate
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  lint:
    name: ðŸ” Lint & Validate
    runs-on: self-hosted

    env:
      COMPOSE_PROJECT_NAME: ci-${{ github.run_id }}-lint

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate docker-compose syntax
        run: docker compose config --quiet

      - name: Install hadolint
        run: |
          HADOLINT_VERSION="v2.12.0"
          mkdir -p "$HOME/.local/bin"
          curl -sSL "https://github.com/hadolint/hadolint/releases/download/${HADOLINT_VERSION}/hadolint-Linux-x86_64" \
            -o "$HOME/.local/bin/hadolint"
          chmod +x "$HOME/.local/bin/hadolint"
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Lint Dockerfiles
        run: |
          set -e
          for f in \
            gateway/docker/development/nginx/Dockerfile \
            gateway/docker/development/php-fpm/Dockerfile \
            gateway/docker/development/php-cli/Dockerfile \
            gateway/docker/development/node/Dockerfile \
            gateway/docker/development/redis/Dockerfile; do
            echo "Linting $f"
            hadolint --failure-threshold error "$f"
          done

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2 â€” Docker Build
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ðŸ³ Docker Build
    runs-on: self-hosted
    needs: lint

    env:
      COMPOSE_PROJECT_NAME: ci-${{ github.run_id }}-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build all images
        run: docker compose build
        env:
          DOCKER_BUILDKIT: 1
          UID: 1000
          GID: 1000

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3 â€” Backend Tests (Laravel)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  backend-tests:
    name: ðŸ§ª Backend Tests (PHP / Laravel)
    runs-on: self-hosted
    needs: build

    env:
      COMPOSE_PROJECT_NAME: ci-${{ github.run_id }}-backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use CI environment
        run: cp api/.env.ci api/.env

      - name: Start database services
        run: docker compose up -d postgres redis
        env:
          DB_DATABASE: ${{ env.DB_DATABASE }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}

      - name: Wait for postgres
        run: |
          echo "Waiting for postgres..."
          for i in {1..30}; do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' gateway_postgres 2>/dev/null || true)
            [ "$STATUS" = "healthy" ] && echo "Postgres ready" && break
            sleep 2
            [ $i -eq 30 ] && echo "Postgres failed" && docker compose logs && exit 1
          done

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: composer-${{ hashFiles('api/composer.lock') }}

      - name: Install Composer dependencies
        run: docker compose run --rm php-cli composer install --no-interaction --prefer-dist

      - name: Fresh database & seed
        run: docker compose run --rm php-cli php artisan migrate:fresh --seed --force

      - name: Run tests
        run: docker compose run --rm php-cli php artisan test

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 4 â€” Frontend Build (Vite)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  frontend:
    name: ðŸŽ¨ Frontend Build (Vite)
    runs-on: self-hosted
    needs: lint

    env:
      COMPOSE_PROJECT_NAME: ci-${{ github.run_id }}-frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build frontend
        run: docker compose run --rm --no-deps node sh -c "npm ci && npm run build"

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 5 â€” Push Images to GHCR (develop only)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  push:
    name: ðŸ“¦ Push images to GHCR
    runs-on: self-hosted
    needs: [backend-tests, frontend]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    permissions:
      contents: read
      packages: write

    env:
      COMPOSE_PROJECT_NAME: ci-${{ github.run_id }}-push

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push php-fpm
        uses: docker/build-push-action@v5
        with:
          context: gateway/docker/development/php-fpm
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/php-fpm:latest

      - name: Build & push nginx
        uses: docker/build-push-action@v5
        with:
          context: gateway/docker/development/nginx
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/nginx:latest