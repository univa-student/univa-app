name: CI Pipeline

on:
  push:
    branches: [feature/* , develop]
  pull_request:
    branches: [feature/* , develop]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DB_DATABASE: app_test
  DB_USERNAME: app
  DB_PASSWORD: secret

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: Lint & Validate
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: ğŸ” Lint & Validate
    runs-on: self-hosted

    steps:
      - name: Fix workspace permissions
        run: |
          if [ -d "${{ github.workspace }}" ]; then
            docker run --rm -v "${{ github.workspace }}:/workspace" alpine \
              chown -R $(id -u):$(id -g) /workspace 2>/dev/null || true
          fi

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create dummy env
        run: cp api/.env.example api/.env

      - name: Validate docker-compose syntax
        run: docker compose config --quiet

      - name: Install hadolint
        run: |
          HADOLINT_VERSION="v2.12.0"
          mkdir -p "$HOME/.local/bin"
          curl -sSL "https://github.com/hadolint/hadolint/releases/download/${HADOLINT_VERSION}/hadolint-Linux-x86_64" \
            -o "$HOME/.local/bin/hadolint"
          chmod +x "$HOME/.local/bin/hadolint"
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          "$HOME/.local/bin/hadolint" --version

      - name: Lint all Dockerfiles
        run: |
          FAILED=0
          for f in \
            "gateway/docker/development/nginx/Dockerfile" \
            "gateway/docker/development/php-fpm/Dockerfile" \
            "gateway/docker/development/php-cli/Dockerfile" \
            "gateway/docker/development/node/Dockerfile" \
            "gateway/docker/development/redis/Dockerfile"; do
            echo "â”€â”€ Linting $f"
            hadolint --failure-threshold error "$f" && echo "  âœ… OK" || FAILED=1
          done
          exit $FAILED

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: Build & smoke-test Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ğŸ³ Docker Build & Smoke Test
    runs-on: self-hosted
    needs: lint

    steps:
      - name: Fix workspace permissions
        run: |
          if [ -d "${{ github.workspace }}" ]; then
            docker run --rm -v "${{ github.workspace }}:/workspace" alpine \
              chown -R $(id -u):$(id -g) /workspace 2>/dev/null || true
          fi

      - name: Checkout code
        uses: actions/checkout@v4

      # âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ .env Ñ„Ğ°Ğ¹Ğ»Ñ‹
      - name: Create root .env (if not exists)
        run: |
          if [ ! -f .env ] && [ -f .env.example ]; then
            cp .env.example .env
          elif [ ! -f .env ]; then
            echo "UID=1000" > .env
            echo "GID=1000" >> .env
          fi

      - name: Create frontend .env (if not exists)
        run: |
          if [ ! -f frontend/.env ] && [ -f frontend/.env.example ]; then
            cp frontend/.env.example frontend/.env
          elif [ ! -f frontend/.env ]; then
            touch frontend/.env
          fi

      - name: Create dummy api env
        run: cp api/.env.example api/.env

      # âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ²ĞµÑ€ÑĞ¸Ñ Docker Compose
      - name: Verify Docker Compose
        run: docker compose version || (echo "Docker Compose V2 not found, trying docker-compose" && docker-compose version)

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build all images
        run: docker compose build --no-cache
        env:
          DOCKER_BUILDKIT: 1
          UID: 1000
          GID: 1000
          DB_DATABASE: ${{ env.DB_DATABASE }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}

      - name: Start postgres & redis
        run: docker compose up -d postgres redis
        env:
          DB_DATABASE: ${{ env.DB_DATABASE }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}

      - name: Wait for postgres to be healthy
        run: |
          echo "Waiting for gateway_postgres..."
          for i in $(seq 1 30); do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' gateway_postgres 2>/dev/null || echo "missing")
            echo "  attempt $i: $STATUS"
            [ "$STATUS" = "healthy" ] && echo "âœ… postgres is healthy" && break
            [ $i -eq 30 ] && echo "âŒ postgres did not become healthy" && docker compose logs postgres && exit 1
            sleep 3
          done

      - name: Wait for redis to be healthy
        run: |
          echo "Waiting for gateway_redis..."
          for i in $(seq 1 20); do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' gateway_redis 2>/dev/null || echo "missing")
            echo "  attempt $i: $STATUS"
            [ "$STATUS" = "healthy" ] && echo "âœ… redis is healthy" && break
            [ $i -eq 20 ] && echo "âŒ redis did not become healthy" && docker compose logs redis && exit 1
            sleep 3
          done

      - name: Start php-fpm, php-cli, nginx, node
        run: docker compose up -d php-fpm php-cli nginx node
        env:
          UID: 1000
          GID: 1000
          DB_DATABASE: ${{ env.DB_DATABASE }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}

      - name: Give services time to start
        run: sleep 8

      - name: Show running containers
        run: docker compose ps

      # âœ… Ğ£Ğ¿Ñ€Ğ¾Ñ‰Ñ‘Ğ½Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°, Ğ±ĞµĞ· Python
      - name: Verify no containers have exited
        run: |
          EXITED=$(docker compose ps --status exited --quiet)
          if [ -n "$EXITED" ]; then
            echo "âŒ Containers exited unexpectedly:"
            docker compose ps --status exited
            docker compose logs
            exit 1
          fi
          echo "âœ… All containers are running"

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3: Backend Tests (PHP / Laravel)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  backend-tests:
    name: ğŸ§ª Backend Tests (PHP)
    runs-on: self-hosted
    needs: build

    steps:
      - name: Fix workspace permissions
        run: |
          if [ -d "${{ github.workspace }}" ]; then
            docker run --rm -v "${{ github.workspace }}:/workspace" alpine \
              chown -R $(id -u):$(id -g) /workspace 2>/dev/null || true
          fi

      - name: Checkout code
        uses: actions/checkout@v4

      # âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ .env Ñ„Ğ°Ğ¹Ğ»Ñ‹
      - name: Create root .env (if not exists)
        run: |
          if [ ! -f .env ] && [ -f .env.example ]; then
            cp .env.example .env
          elif [ ! -f .env ]; then
            echo "UID=1000" > .env
            echo "GID=1000" >> .env
          fi

      - name: Create dummy api env
        run: cp api/.env.example api/.env

      - name: Create frontend .env (if not exists)
        run: |
          if [ ! -f frontend/.env ] && [ -f frontend/.env.example ]; then
            cp frontend/.env.example frontend/.env
          elif [ ! -f frontend/.env ]; then
            touch frontend/.env
          fi

      - name: Verify Docker Compose
        run: docker compose version || (echo "Docker Compose V2 not found, trying docker-compose" && docker-compose version)

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Restore Docker layer cache
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build images
        run: docker compose build
        env:
          DOCKER_BUILDKIT: 1
          UID: 1000
          GID: 1000

      - name: Start postgres & redis
        run: docker compose up -d postgres redis
        env:
          DB_DATABASE: ${{ env.DB_DATABASE }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}

      - name: Wait for postgres & redis
        run: |
          for svc in gateway_postgres gateway_redis; do
            echo "Waiting for $svc..."
            for i in $(seq 1 30); do
              STATUS=$(docker inspect --format='{{.State.Health.Status}}' $svc 2>/dev/null || echo "missing")
              [ "$STATUS" = "healthy" ] && echo "âœ… $svc healthy" && break
              [ $i -eq 30 ] && echo "âŒ $svc not healthy" && docker compose logs && exit 1
              sleep 3
            done
          done

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ./api/vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Ensure vendor directory exists (inside container)
        run: docker compose run --rm php-cli mkdir -p /var/www/app/vendor
        env:
          DB_DATABASE: ${{ env.DB_DATABASE }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}

      - name: Install Composer dependencies
        run: |
          docker compose run --rm php-cli composer install \
            --no-interaction \
            --no-progress \
            --prefer-dist \
            --optimize-autoloader
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ñ‡Ğ¸Ğº Ğ¿Ğ¾ÑĞ²Ğ¸Ğ»ÑÑ
          if [ ! -f api/vendor/autoload.php ]; then
            echo "âŒ Composer install failed: vendor/autoload.php not found"
            exit 1
          fi
        env:
          DB_DATABASE: ${{ env.DB_DATABASE }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}

      - name: Generate app key
        run: docker compose run --rm php-cli php artisan key:generate --force
        env:
          DB_DATABASE: ${{ env.DB_DATABASE }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}

      - name: Run database migrations
        run: docker compose run --rm php-cli php artisan migrate --force
        env:
          DB_DATABASE: ${{ env.DB_DATABASE }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}

      - name: Run tests
        run: |
          docker compose run --rm php-cli php artisan test
        env:
          DB_DATABASE: ${{ env.DB_DATABASE }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 4: Frontend Build Check (Node / Vite)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  frontend-build:
    name: ğŸ¨ Frontend Build (Vite)
    runs-on: self-hosted
    needs: lint

    steps:
      - name: Fix workspace permissions
        run: |
          if [ -d "${{ github.workspace }}" ]; then
            docker run --rm -v "${{ github.workspace }}:/workspace" alpine \
              chown -R $(id -u):$(id -g) /workspace 2>/dev/null || true
          fi

      - name: Checkout code
        uses: actions/checkout@v4

      # âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ .env Ğ´Ğ»Ñ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ°
      - name: Create frontend .env (if not exists)
        run: |
          if [ ! -f frontend/.env ] && [ -f frontend/.env.example ]; then
            cp frontend/.env.example frontend/.env
          elif [ ! -f frontend/.env ]; then
            touch frontend/.env
          fi

      # ĞšĞ¾Ñ€Ğ½ĞµĞ²Ğ¾Ğ¹ .env Ñ‚Ğ¾Ğ¶Ğµ Ğ¿Ğ¾Ğ»ĞµĞ·ĞµĞ½ (UID/GID Ğ´Ğ»Ñ Ğ±Ğ¸Ğ»Ğ´Ğ° node)
      - name: Create root .env (if not exists)
        run: |
          if [ ! -f .env ] && [ -f .env.example ]; then
            cp .env.example .env
          elif [ ! -f .env ]; then
            echo "UID=1000" > .env
            echo "GID=1000" >> .env
          fi

      - name: Verify Docker Compose
        run: docker compose version || (echo "Docker Compose V2 not found, trying docker-compose" && docker-compose version)

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build node image
        run: docker compose build node
        env:
          DOCKER_BUILDKIT: 1

      - name: Install dependencies & build
        run: |
          docker compose run --rm --no-deps node sh -c "npm ci && npm run build"

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 5: Push php-fpm & nginx images (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ push Ğ² feature/docker)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  push:
    name: ğŸ“¦ Push images to GHCR
    runs-on: self-hosted
    needs: [backend-tests, frontend-build]
    if: github.ref == 'refs/heads/feature/docker' && github.event_name == 'push'

    permissions:
      contents: read
      packages: write

    steps:
      - name: Fix workspace permissions
        run: |
          if [ -d "${{ github.workspace }}" ]; then
            docker run --rm -v "${{ github.workspace }}:/workspace" alpine \
              chown -R $(id -u):$(id -g) /workspace 2>/dev/null || true
          fi

      - name: Checkout code
        uses: actions/checkout@v4

      # âœ… ĞšĞ¾Ñ€Ğ½ĞµĞ²Ğ¾Ğ¹ .env Ğ´Ğ»Ñ build args (UID/GID)
      - name: Create root .env (if not exists)
        run: |
          if [ ! -f .env ] && [ -f .env.example ]; then
            cp .env.example .env
          elif [ ! -f .env ]; then
            echo "UID=1000" > .env
            echo "GID=1000" >> .env
          fi

      - name: Verify Docker Compose
        run: docker compose version || (echo "Docker Compose V2 not found, trying docker-compose" && docker-compose version)

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ php-fpm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Metadata â€” php-fpm
        id: meta-php
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/php-fpm
          tags: |
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build & push â€” php-fpm
        uses: docker/build-push-action@v5
        with:
          context: ./gateway/docker/development/php-fpm
          push: true
          tags: ${{ steps.meta-php.outputs.tags }}
          labels: ${{ steps.meta-php.outputs.labels }}
          build-args: |
            UID=1000
            GID=1000

      # â”€â”€ nginx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Metadata â€” nginx
        id: meta-nginx
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/nginx
          tags: |
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build & push â€” nginx
        uses: docker/build-push-action@v5
        with:
          context: ./gateway/docker/development/nginx
          push: true
          tags: ${{ steps.meta-nginx.outputs.tags }}
          labels: ${{ steps.meta-nginx.outputs.labels }}

      # â”€â”€ node (frontend build artifact) â”€â”€â”€â”€â”€â”€â”€
      - name: Metadata â€” node
        id: meta-node
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/node
          tags: |
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build & push â€” node
        uses: docker/build-push-action@v5
        with:
          context: ./gateway/docker/development/node
          push: true
          tags: ${{ steps.meta-node.outputs.tags }}
          labels: ${{ steps.meta-node.outputs.labels }}

      # âœ… Ğ Ğ¾Ñ‚Ğ°Ñ†Ğ¸Ñ ĞºĞµÑˆĞ° ÑĞ»Ğ¾Ñ‘Ğ² (Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾)
      - name: Move Docker layer cache (if new cache exists)
        run: |
          if [ -d /tmp/.buildx-cache-new ]; then
            rm -rf /tmp/.buildx-cache
            mv /tmp/.buildx-cache-new /tmp/.buildx-cache
          fi