name: CI Pipeline

on:
  push:
    branches: [main, develop, feature-workflow]
  pull_request:
    branches: [main, develop, feature-workflow]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DB_DATABASE: app_test
  DB_USERNAME: app
  DB_PASSWORD: secret

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: Lint & Validate
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: ðŸ” Lint & Validate
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐ° docker-compose.yml
      - name: Validate docker-compose syntax
        run: docker compose config --quiet

      # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ hadolint ÐºÐ°Ðº Ð±Ð¸Ð½Ð°Ñ€Ð½Ð¸Ðº â€” Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° Ð»ÑŽÐ±Ð¾Ð¼ runner'Ðµ (Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ self-hosted)
      - name: Install hadolint
        run: |
          HADOLINT_VERSION="v2.12.0"
          mkdir -p "$HOME/.local/bin"
          curl -sSL "https://github.com/hadolint/hadolint/releases/download/${HADOLINT_VERSION}/hadolint-Linux-x86_64" \
            -o "$HOME/.local/bin/hadolint"
          chmod +x "$HOME/.local/bin/hadolint"
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          "$HOME/.local/bin/hadolint" --version

      # Ð›Ð¸Ð½Ñ‚Ð¸Ð½Ð³ Ð²ÑÐµÑ… Dockerfile'Ð¾Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð¾Ð´Ð½Ð¾Ð¹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹
      - name: Lint all Dockerfiles
        run: |
          FAILED=0
          for f in \
            "gateway/docker/development/nginx/Dockerfile" \
            "gateway/docker/development/php-fpm/Dockerfile" \
            "gateway/docker/development/php-cli/Dockerfile" \
            "gateway/docker/development/node/Dockerfile" \
            "gateway/docker/development/redis/Dockerfile"; do
            echo "â”€â”€ Linting $f"
            hadolint --failure-threshold error "$f" && echo "  âœ… OK" || FAILED=1
          done
          exit $FAILED

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: Build & smoke-test Ð²ÑÐµÑ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ðŸ³ Docker Build & Smoke Test
    runs-on: self-hosted
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ñ„Ð°Ð¹Ð»Ñ‹ ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ðµ Docker (root) Ð² Ð¿Ñ€Ð¾ÑˆÐ»Ñ‹Ñ… Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ…
      # Ð‘ÐµÐ· ÑÑ‚Ð¾Ð³Ð¾ git checkout Ð¿Ð°Ð´Ð°ÐµÑ‚ Ñ EACCES permission denied
      - name: Fix workspace permissions
        run: docker run --rm -v "${{ github.workspace }}:/workspace" alpine chown -R $(id -u):$(id -g) /workspace

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build all images
        run: docker compose build --no-cache
        env:
          DOCKER_BUILDKIT: 1
          UID: 1000
          GID: 1000
          DB_DATABASE: ${{ env.DB_DATABASE }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}

      # Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ð¾Ð´Ð½Ð¸Ð¼Ð°ÐµÐ¼ postgres Ð¸ redis â€” Ñƒ Ð½Ð¸Ñ… Ð¿Ñ€Ð¾Ð¿Ð¸ÑÐ°Ð½Ñ‹ healthcheck'Ð¸ Ð² compose
      - name: Start postgres & redis
        run: docker compose up -d postgres redis
        env:
          DB_DATABASE: ${{ env.DB_DATABASE }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}

      - name: Wait for postgres to be healthy
        run: |
          echo "Waiting for gateway_postgres..."
          for i in $(seq 1 30); do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' gateway_postgres 2>/dev/null || echo "missing")
            echo "  attempt $i: $STATUS"
            [ "$STATUS" = "healthy" ] && echo "âœ… postgres is healthy" && break
            [ $i -eq 30 ] && echo "âŒ postgres did not become healthy" && docker compose logs postgres && exit 1
            sleep 3
          done

      - name: Wait for redis to be healthy
        run: |
          echo "Waiting for gateway_redis..."
          for i in $(seq 1 20); do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' gateway_redis 2>/dev/null || echo "missing")
            echo "  attempt $i: $STATUS"
            [ "$STATUS" = "healthy" ] && echo "âœ… redis is healthy" && break
            [ $i -eq 20 ] && echo "âŒ redis did not become healthy" && docker compose logs redis && exit 1
            sleep 3
          done

      # Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¿Ð¾Ð´Ð½Ð¸Ð¼Ð°ÐµÐ¼ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹
      - name: Start php-fpm, php-cli, nginx, node
        run: docker compose up -d php-fpm php-cli nginx node
        env:
          UID: 1000
          GID: 1000
          DB_DATABASE: ${{ env.DB_DATABASE }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}

      - name: Give services time to start
        run: sleep 8

      - name: Show running containers
        run: docker compose ps

      # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð½Ð¸ Ð¾Ð´Ð¸Ð½ ÑÐµÑ€Ð²Ð¸Ñ Ð½Ðµ ÑƒÐ¿Ð°Ð» (Exit code != 0)
      - name: Verify no containers have exited
        run: |
          EXITED=$(docker compose ps --status exited --format json 2>/dev/null | python3 -c "
          import sys, json
          lines = [l for l in sys.stdin if l.strip()]
          services = [json.loads(l) for l in lines]
          if services:
              names = [s.get('Name', s.get('Service', '?')) for s in services]
              print(' '.join(names))
          " 2>/dev/null || echo "")
          if [ -n "$EXITED" ]; then
            echo "âŒ Containers exited unexpectedly: $EXITED"
            docker compose logs
            exit 1
          fi
          echo "âœ… All containers are running"

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3: Backend Tests (PHP / Laravel)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  backend-tests:
    name: ðŸ§ª Backend Tests (PHP)
    runs-on: self-hosted
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Fix workspace permissions
        run: docker run --rm -v "${{ github.workspace }}:/workspace" alpine chown -R $(id -u):$(id -g) /workspace

      - name: Restore Docker layer cache
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build images
        run: docker compose build
        env:
          DOCKER_BUILDKIT: 1
          UID: 1000
          GID: 1000

      - name: Start postgres & redis
        run: docker compose up -d postgres redis
        env:
          DB_DATABASE: ${{ env.DB_DATABASE }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}

      - name: Wait for postgres & redis
        run: |
          for svc in gateway_postgres gateway_redis; do
            echo "Waiting for $svc..."
            for i in $(seq 1 30); do
              STATUS=$(docker inspect --format='{{.State.Health.Status}}' $svc 2>/dev/null || echo "missing")
              [ "$STATUS" = "healthy" ] && echo "âœ… $svc healthy" && break
              [ $i -eq 30 ] && echo "âŒ $svc not healthy" && docker compose logs && exit 1
              sleep 3
            done
          done

      # ÐšÐµÑˆÐ¸Ñ€ÑƒÐµÐ¼ vendor/ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð¿Ð°ÐºÐµÑ‚Ñ‹ Ð¿Ñ€Ð¸ ÐºÐ°Ð¶Ð´Ð¾Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐµ
      # ÐšÐ»ÑŽÑ‡ Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½ Ðº composer.lock â€” Ð¿Ñ€Ð¸ ÐµÐ³Ð¾ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ ÐºÐµÑˆ ÑÐ±Ñ€Ð¾ÑÐ¸Ñ‚ÑÑ
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ./api/vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      # Composer Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ ÑÐ°Ð¼ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ vendor/ ÐµÑÐ»Ð¸ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ â€”
      # ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ Ð·Ð°Ñ€Ð°Ð½ÐµÐµ Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ (UID 1000 = Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ php-cli)
      - name: Prepare vendor directory
        run: |
          mkdir -p ./api/vendor
          sudo chown -R 1000:1000 ./api/vendor

      # vendor/ Ð½Ðµ Ð¿Ð¾Ð¿Ð°Ð´Ð°ÐµÑ‚ Ð² git â€” ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ
      - name: Install Composer dependencies
        run: |
          docker compose run --rm php-cli composer install \
            --no-interaction \
            --no-progress \
            --prefer-dist \
            --optimize-autoloader
        env:
          DB_DATABASE: ${{ env.DB_DATABASE }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}

      # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ php-cli â€” Ð¾Ð½ Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ postgres Ð¸ redis (depends_on Ð¿Ñ€Ð¾Ð¿Ð¸ÑÐ°Ð½ Ð² compose)
      - name: Run database migrations
        run: |
          docker compose run --rm php-cli php artisan migrate --force
        env:
          DB_DATABASE: ${{ env.DB_DATABASE }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}

      # Ð—Ð°Ð¿ÑƒÑÐº PHPUnit / Pest
      # --parallel â€” ÐµÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑˆÑŒ Pest Ñ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ñ‹Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼
      - name: Run tests
        run: |
          docker compose run --rm php-cli php artisan test --parallel
        env:
          DB_DATABASE: ${{ env.DB_DATABASE }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 4: Frontend Build Check (Node / Vite)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  frontend-build:
    name: ðŸŽ¨ Frontend Build (Vite)
    runs-on: self-hosted
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Fix workspace permissions
        run: docker run --rm -v "${{ github.workspace }}:/workspace" alpine chown -R $(id -u):$(id -g) /workspace

      # Ð‘Ð¸Ð»Ð´Ð¸Ð¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ node-Ð¾Ð±Ñ€Ð°Ð· â€” Ð½Ðµ Ð½ÑƒÐ¶Ð½Ð° Ð‘Ð”
      - name: Build node image
        run: docker compose build node
        env:
          DOCKER_BUILDKIT: 1

      # --no-deps Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ñ‚ÑÐ½ÑƒÑ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹
      # Ð•ÑÐ»Ð¸ package.json Ð² ./frontend â€” Ð²ÑÑ‘ ÑƒÐ¶Ðµ ÑÐ¼Ð¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ñ‡ÐµÑ€ÐµÐ· volume Ð² compose
      - name: Install dependencies & build
        run: |
          docker compose run --rm --no-deps node sh -c "npm ci && npm run build"

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 5: Push php-fpm & nginx images (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ push Ð² main)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  push:
    name: ðŸ“¦ Push images to GHCR
    runs-on: self-hosted
    needs: [backend-tests, frontend-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ php-fpm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Metadata â€” php-fpm
        id: meta-php
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/php-fpm
          tags: |
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build & push â€” php-fpm
        uses: docker/build-push-action@v5
        with:
          context: ./gateway/docker/development/php-fpm
          push: true
          tags: ${{ steps.meta-php.outputs.tags }}
          labels: ${{ steps.meta-php.outputs.labels }}
          build-args: |
            UID=1000
            GID=1000

      # â”€â”€ nginx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Metadata â€” nginx
        id: meta-nginx
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/nginx
          tags: |
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build & push â€” nginx
        uses: docker/build-push-action@v5
        with:
          context: ./gateway/docker/development/nginx
          push: true
          tags: ${{ steps.meta-nginx.outputs.tags }}
          labels: ${{ steps.meta-nginx.outputs.labels }}

      # â”€â”€ node (frontend build artifact) â”€â”€â”€â”€â”€â”€â”€
      - name: Metadata â€” node
        id: meta-node
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/node
          tags: |
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build & push â€” node
        uses: docker/build-push-action@v5
        with:
          context: ./gateway/docker/development/node
          push: true
          tags: ${{ steps.meta-node.outputs.tags }}
          labels: ${{ steps.meta-node.outputs.labels }}

      # Ð Ð¾Ñ‚Ð°Ñ†Ð¸Ñ ÐºÐµÑˆÐ° ÑÐ»Ð¾Ñ‘Ð²
      - name: Move Docker layer cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache 2>/dev/null || true